<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files - TorTul Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .navbar {
            background-color: #333;
            overflow: hidden;
        }
        .navbar a {
            float: left;
            display: block;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 20px;
            text-decoration: none;
        }
        .navbar a:hover {
            background-color: #ddd;
            color: black;
        }
        .content {
            padding: 20px;
        }
        .header {
            text-align: center;
            margin: 50px 0;
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
        }
        .description {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            font-size: 1.2em;
            color: #555;
        }
        .file-explorer {
            max-width: 80%;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .file-explorer table {
            width: 100%;
            border-collapse: collapse;
        }
        .file-explorer th, .file-explorer td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .file-explorer th {
            background-color: #333;
            color: #fff;
        }
        .search-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .search-container input {
            padding: 8px;
            width: 80%;
            max-width: 400px;
        }
        .search-container button {
            padding: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-icon, .folder-icon {
            width: 1em;
            height: 1em;
            vertical-align: middle;
            margin-right: 0.5em;
        }
        .expand-text {
            color: blue;
            cursor: pointer;
        }
        .expand-text:hover {
            color: darkblue;
        }
        .boxpath {
            margin: 3px;
            color: blue;
            cursor: pointer;
        }
        .boxpath:hover {
            color: darkblue;
        }
    </style>
    <script>
        const webhook = localStorage.getItem('webhook');
        if (webhook === null) {
            window.location.href = '/TorTulStorage/login';
        }

        let DATA = JSON.parse(localStorage.getItem('DATA'));
        if (DATA === null) {
            DATA = []
        }

        // List des fichiers
        var file_name = [];

        async function Download(id) {
            const response = await fetch(`${webhook}/messages/${id}`, {
                method: 'GET'
            });
            const data = await response.json();
            const messageUrl = data.attachments[0].url;

            window.location.href = messageUrl;
        }

        async function sendFileToWebhook(webhook, file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(webhook, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            const messageId = data.id;

            return messageId;
        }

        function formatFileSize(sizeInBytes) {
            const units = ['o', 'ko', 'Mo', 'Go', 'To']; // Ajoutez plus d'unités si nécessaire
            let size = sizeInBytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }

        function GetAllFileName(data) {
            data.forEach(file => {
                if (file.t === 'folder') {
                    GetAllFileName(file.data);
                }
                file_name.push({ name: file.n, path: file.p });
            });
        }

        GetAllFileName(DATA);

        function loadfiledata(data, name) {
            const tableBody = document.getElementById('file-list');
            tableBody.innerHTML = ''; // Effacer le contenu précédent

            data.forEach(file => {
                const row = document.createElement('tr');

                if (file.t === 'file') {
                    row.innerHTML = `
                        <td>
                            <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="file" class="svg-inline--fa fa-file fa-xl file-icon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <path fill="currentColor" d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z"></path>
                            </svg>
                            ${file.n}
                        </td>
                        <td>${file.s}</td>
                        <td>${file.d}</td>
                        <td>${file.p}</td>
                        <td class="expand-text" onclick='Download(${JSON.stringify(file.id)})'>Télécharger</td>
                    `;
                } else if (file.t === 'folder') {
                    row.innerHTML = `
                        <td>
                            <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="folder" class="svg-inline--fa fa-folder fa-xl folder-icon" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path fill="currentColor" d="M64 480H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H288c-10.1 0-19.6-4.7-25.6-12.8L243.2 57.6C231.1 41.5 212.1 32 192 32H64C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64z"></path>
                            </svg>
                            ${file.n}
                        </td>
                        <td>${file.s}</td>
                        <td>${file.d}</td>
                        <td>${file.p}</td>
                        <td class="expand-text" onclick='expandFolder(${JSON.stringify(file.data)},"${file.n}")'>Agrandir</td>
                    `;
                }
                tableBody.appendChild(row);
            });

            const path = document.getElementById('file_path');
            let content = `<div class="boxpath" onclick='expandFolder(${JSON.stringify(DATA)},"DATA")'>Stockage ></div>`;
            
            var data_path = DATA;

            if (!data[0]) {
                path.innerHTML += `<div class="boxpath">${name} ></div>`;
                return;
            }

            const d = data[0].p.split('/').slice(1, -1);

            d.forEach(filename => {
                data_path.forEach(file => {
                    if (file.n === filename) {
                        content += `<div class="boxpath" onclick='expandFolder(${JSON.stringify(file.data)},"${file.n}")'>${filename} ></div>`;
                        data_path = file.data;
                        return;
                    }
                });
            });

            path.innerHTML = content;
        }

        function expandFolder(data, name) {
            console.log('Agrandir le dossier:', data, '\nNom:', name);
            loadfiledata(data, name);
        }

        async function AddFile(path, n, data, file) {
            console.log('path AddFile:', path);

            if (DATA == false) {
                DATA.splice(1, 0, data);
                localStorage.setItem('DATA',JSON.stringify(DATA))
                loadfiledata(DATA, 'DATA');
                return;
            }

            const segments = path.split('/').filter(Boolean); // Filter out empty strings

            file_name.push({ name: data.n, path: data.p });

            const datalist = document.getElementById('suggestions');
            const option = document.createElement('option');
            option.value = data.n;
            option.textContent = data.p;
            datalist.appendChild(option);

            if (path === '') {
                DATA.splice(1, 0, data);
                localStorage.setItem('DATA',JSON.stringify(DATA));
                loadfiledata(DATA, 'DATA');
                return;
            }

            function FindPath(path, n, data) {
                let path_ = '';
                const segments = path.replace('/', '').split('/');

                for (let i = 0; i < n + 1; i++) {
                    path_ += ('/' + segments[i]);
                }

                const Data = data.find(item => {
                    if (item.p === path_)
                        return item;
                });

                if (Data.p === path)
                    return Data;
                console.log('next FindPath:', Data.data);
                return FindPath(path, n + 1, Data.data);
            }

            const parentFolder = FindPath(path, 0, DATA);
            parentFolder.data.splice(1, 0, data);

            localStorage.setItem('DATA',JSON.stringify(DATA));

            loadfiledata(parentFolder.data, parentFolder.n);
        }

        // Once the page is loaded
        window.onload = () => {
            if (DATA.length != 0) {
                loadfiledata(DATA, 'DATA');
            }

            const datalist = document.getElementById('suggestions');

            file_name.forEach(file => {
                const option = document.createElement('option');
                option.value = file.name;
                option.textContent = file.path;
                datalist.appendChild(option);
            });

            // Event when the user sends the selected file
            const searchInput = document.getElementById('search');

            function searchInputEvent(value) {
                file_name.forEach(file => {
                    if (file.name === value) {
                        var data_path = DATA;
                        const d = file.path.split('/').slice(1, -1);

                        if (d.length == 0) {
                            loadfiledata(DATA, 'DATA');
                        }

                        d.forEach(filename => {
                            data_path.forEach(file => {
                                if (file.n === filename) {
                                    if (file.n === d[d.length - 1]) {
                                        loadfiledata(file.data, file.n);
                                        return;
                                    }
                                    data_path = file.data;
                                    return;
                                }
                            });
                        });

                        return;
                    }
                });
            }

            searchInput.addEventListener('keydown', function(event) {
                if (event.keyCode === 13) {
                    searchInputEvent(searchInput.value);
                }
            });

            searchInput.addEventListener('change', function() {
                searchInputEvent(searchInput.value);
            });

            // Event when the user creates a new file/folder
            const create_folder = document.getElementById('add-folder');
            const create_file = document.getElementById('add-file');

            create_file.addEventListener('click', function() {
                document.getElementById('upload-file').click();
            });

            create_folder.addEventListener('click', function() {
                const name = prompt('Nom du dossier');

                const path = document.getElementById('file_path');
                const full_path = (Array.from(path.children).map(obj => obj.textContent)).join('/').replaceAll(' >', '').replace('Stockage', '');

                const data_to_add = {
                    "t": "folder",
                    "n": name,
                    "s": "",
                    "d": new Date().toLocaleString(),
                    "p": full_path + '/' + name,
                    "data": []
                };

                AddFile(full_path, 0, data_to_add);
            });

            document.getElementById('upload-file').addEventListener('change', async function(event) {
                const files = event.target.files;
                const path = document.getElementById('file_path');
                const full_path = (Array.from(path.children).map(obj => obj.textContent)).join('/').replaceAll(' >', '').replace('Stockage', '');

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if(file.size >= 26214400){
                        return alert(`Your size file cant be more of 25Mo (${formatFileSize(file.size)})`)
                    }

                    const date = new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;

                    const data_to_add = {
                        "t": "file",
                        "n": file.name,
                        "s": `${formatFileSize(file.size)}`,
                        "d": formattedDate,
                        "p": `${full_path}/${file.name}`
                    };

                    let currentData = DATA;

                    const segments = full_path.split('/').filter(Boolean); // Filter out empty strings

                    for (let i = 0; i < segments.length; i++) {
                        let foundFolder = currentData.find(item => item.t === 'folder' && item.n === segments[i]);
                        if (!foundFolder) {
                            return alert('Path does not exist.');
                        }
                        currentData = foundFolder.data;
                    }

                    // Check for duplicate file or folder
                    let duplicate = currentData.find(item => item.n === data_to_add.n && item.t === data_to_add.t);
                    if (duplicate) {
                        alert(`File or folder already exists. (${file.name})`);
                    } else {
                        const webhookResponse = await sendFileToWebhook(webhook, file);
                        console.log('webhook response:',webhookResponse)

                        data_to_add.id = webhookResponse

                        AddFile(full_path, 0, data_to_add, file);
                    }
                }
            });
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="/TorTulStorage/home">Home</a>
        <a href="/TorTulStorage/files">Files</a>
        <a href="/TorTulStorage/login">Login</a>
    </div>

    <div class="content">
        <div class="header">
            <h1>Explorateur de fichiers - TorTul Storage</h1>
        </div>
        <div class="file-explorer">
            <div class="search-container">
                <button id="add-folder">Ajouter un dossier</button>
                <button id="add-file">Upload un fichier</button>
                <input type="file" id="upload-file" style="display: none;" multiple>
                <input type="text" id="search" placeholder="Rechercher un fichier..." autocomplete="off" list="suggestions" name="suggestions">
                <datalist id="suggestions"></datalist>
            </div>
            <div style="display: flex" id="file_path">
                <div class="boxpath">Stockage ></div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Taille</th>
                        <th>Date</th>
                        <th>Chemin</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="file-list">
                    <!-- Les fichiers seront chargés ici par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
